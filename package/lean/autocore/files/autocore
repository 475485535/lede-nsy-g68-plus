#!/bin/sh /etc/rc.common
# Copyright (C) 2017 lean <coolsnowwolf@gmail.com>

START=99

start()
{
	rfc=4096
	cc=$(grep -c processor /proc/cpuinfo)
	
	if [ $cc -lt 2 ]; then
		echo "No need to enable RPC/RFC on a single-core platform."
		exit 1
	fi
	
	rsfe=$((rfc * cc))
	sysctl -w net.core.rps_sock_flow_entries=$rsfe
	for fileRps in $(ls /sys/class/net/eth*/queues/rx-*/rps_cpus)
	do
		echo $cc > $fileRps
	done
	
	for fileRfc in $(ls /sys/class/net/eth*/queues/rx-*/rps_flow_cnt)
	do
		echo $rfc > $fileRfc
	done
	
	for fileRps in $(ls /sys/class/net/eth*/queues/tx-*/xps_cpus)
	do
		echo $cc > $fileRps
	done
	
	a=$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq)
	b=$(echo -n ' x ')
	c=$(grep -c processor /proc/cpuinfo)
	f=${a}${b}${c}
	echo $f > /tmp/sysinfo/model
}

stop()
{
	sysctl -w net.core.rps_sock_flow_entries=0
	for fileRps in $(ls /sys/class/net/eth*/queues/rx-*/rps_cpus)
	do
		echo 0 > $fileRps
	done

	for fileRfc in $(ls /sys/class/net/eth*/queues/rx-*/rps_flow_cnt)
	do
		echo 0 > $fileRfc
	done

	for fileRps in $(ls /sys/class/net/eth*/queues/tx-*/xps_cpus)
	do
		echo 0 > $fileRps
	done

	rm -f /tmp/sysinfo/model
}
